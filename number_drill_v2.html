<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Number Listening Drill</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            margin: 0;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        
        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin: 0 0 8px 0;
            color: #fff;
        }
        
        .subtitle {
            text-align: center;
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 16px;
        }
        
        .card {
            background: rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
        }
        
        .type-badge {
            display: inline-block;
            background: #4a69bd;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 12px;
        }
        
        .voice-indicator {
            float: right;
            font-size: 0.75rem;
            color: #888;
            padding: 4px 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        .play-btn {
            width: 100%;
            padding: 20px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #6a89cc 0%, #4a69bd 100%);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.1s, opacity 0.1s;
        }
        
        .play-btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .play-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 16px;
            font-size: 1.3rem;
            border: 2px solid #444;
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            text-align: center;
            outline: none;
        }
        
        input[type="text"]:focus {
            border-color: #4a69bd;
        }
        
        .submit-btn {
            padding: 16px 24px;
            font-size: 1.1rem;
            background: #27ae60;
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
        }
        
        .submit-btn:active {
            background: #219a52;
        }
        
        .feedback {
            text-align: center;
            padding: 16px;
            border-radius: 12px;
            margin-top: 12px;
            font-size: 1.1rem;
            display: none;
        }
        
        .feedback.correct {
            background: rgba(39, 174, 96, 0.3);
            border: 1px solid #27ae60;
            display: block;
        }
        
        .feedback.wrong {
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid #e74c3c;
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .stat-item {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .stat-value.good { color: #27ae60; }
        .stat-value.bad { color: #e74c3c; }
        
        .settings {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .setting-btn {
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid #444;
            background: transparent;
            color: #aaa;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .setting-btn.active {
            background: #4a69bd;
            border-color: #4a69bd;
            color: white;
        }
        
        .category-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .cat-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #444;
            background: transparent;
            color: #888;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .cat-btn.active {
            background: rgba(74, 105, 189, 0.4);
            border-color: #4a69bd;
            color: #fff;
        }
        
        .progress-bar {
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s;
        }
        
        .hint {
            color: #666;
            font-size: 0.8rem;
            text-align: center;
            margin-top: 8px;
        }
        
        .voice-select {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            border: 1px solid #444;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 0.9rem;
        }
        
        .voice-select option {
            background: #1a1a2e;
        }
    </style>
</head>
<body>
    <h1>üéß Number Drill</h1>
    <p class="subtitle">English Listening Practice for Numbers</p>
    
    <div class="settings">
        <button class="setting-btn" data-speed="0.7">üê¢ Slow</button>
        <button class="setting-btn active" data-speed="0.85">üö∂ Normal</button>
        <button class="setting-btn" data-speed="1.0">üèÉ Fast</button>
    </div>
    
    <div class="category-toggles" id="categoryToggles"></div>
    
    <div class="card">
        <span class="type-badge" id="typeBadge">Ready</span>
        <span class="voice-indicator" id="voiceIndicator">--</span>
        
        <button class="play-btn" id="playBtn" onclick="playQuestion()">
            <span>‚ñ∂Ô∏è</span> <span id="playText">Tap to Play</span>
        </button>
        
        <div class="input-row">
            <input type="text" id="answerInput" placeholder="Type your answer" autocomplete="off" inputmode="text">
            <button class="submit-btn" onclick="checkAnswer()">Check</button>
        </div>
        
        <div class="feedback" id="feedback"></div>
        <p class="hint" id="hintText"></p>
        
        <select class="voice-select" id="voiceSelect">
            <option value="">Loading voices...</option>
        </select>
    </div>
    
    <div class="card">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-label">Correct</div>
                <div class="stat-value good" id="correctCount">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Total</div>
                <div class="stat-value" id="totalCount">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Accuracy</div>
                <div class="stat-value" id="accuracy">--%</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Streak</div>
                <div class="stat-value" id="streak">0</div>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <script>
        // Number to words conversion
        const ONES = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine",
                      "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", 
                      "seventeen", "eighteen", "nineteen"];
        const TENS = ["", "", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];
        const MONTHS = ["", "January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November", "December"];

        function numToWords(n) {
            if (n < 20) return ONES[n];
            if (n < 100) {
                const [t, o] = [Math.floor(n / 10), n % 10];
                return TENS[t] + (o ? " " + ONES[o] : "");
            }
            if (n < 1000) {
                const [h, r] = [Math.floor(n / 100), n % 100];
                return ONES[h] + " hundred" + (r ? " and " + numToWords(r) : "");
            }
            if (n < 10000) {
                const [t, r] = [Math.floor(n / 1000), n % 1000];
                return numToWords(t) + " thousand" + (r ? " " + numToWords(r) : "");
            }
            return String(n);
        }

        function ordinal(n) {
            const specials = {1:"first",2:"second",3:"third",21:"twenty first",22:"twenty second",23:"twenty third",31:"thirty first"};
            if (specials[n]) return specials[n];
            if (n < 20) return ONES[n] + "th";
            const [t, o] = [Math.floor(n / 10), n % 10];
            if (o === 0) return TENS[t] + "th";
            return TENS[t] + " " + ordinal(o);
        }

        // Question generators
        const generators = {
            TEEN_TY: () => {
                const teen = 13 + Math.floor(Math.random() * 7);
                let ty = [30,40,50,60,70,80,90][Math.floor(Math.random() * 7)];
                if (Math.random() > 0.5) ty += 1 + Math.floor(Math.random() * 9);
                const target = Math.random() > 0.5 ? teen : ty;
                return { target: String(target), speech: numToWords(target), hint: "Teen vs Ty (13-19 / 30-90)", type: "TEEN_TY" };
            },
            
            PHONE: () => {
                const len = 5 + Math.floor(Math.random() * 4);
                let digits = "";
                for (let i = 0; i < len; i++) digits += Math.floor(Math.random() * 10);
                
                let speech = [], i = 0;
                while (i < digits.length) {
                    let count = 1;
                    while (i + count < digits.length && digits[i + count] === digits[i]) count++;
                    const sound = digits[i] === "0" ? (Math.random() > 0.3 ? "oh" : "zero") : digits[i];
                    if (count >= 3) { speech.push("triple " + sound); i += 3; }
                    else if (count >= 2) { speech.push("double " + sound); i += 2; }
                    else { speech.push(sound); i++; }
                }
                return { target: digits, speech: speech.join(", "), hint: `Phone (${len} digits)`, type: "PHONE" };
            },
            
            PRICE: () => {
                const dollars = 1 + Math.floor(Math.random() * 99);
                const cents = [0,10,15,20,25,30,49,50,75,95,99][Math.floor(Math.random() * 11)];
                if (cents === 0) {
                    return { target: String(dollars), speech: numToWords(dollars) + " dollars", hint: "Price", type: "PRICE" };
                }
                const target = dollars + "." + String(cents).padStart(2, "0");
                return { target, speech: numToWords(dollars) + " " + numToWords(cents), hint: "Price (x.xx)", type: "PRICE" };
            },
            
            TIME: () => {
                const hour = 1 + Math.floor(Math.random() * 12);
                const minute = [0,5,10,15,20,25,30,35,40,45,50,55][Math.floor(Math.random() * 12)];
                let speech;
                if (minute === 0) speech = numToWords(hour) + " o'clock";
                else if (minute === 15) speech = Math.random() > 0.5 ? "quarter past " + numToWords(hour) : numToWords(hour) + " fifteen";
                else if (minute === 30) speech = Math.random() > 0.5 ? "half past " + numToWords(hour) : numToWords(hour) + " thirty";
                else if (minute === 45) {
                    const next = hour === 12 ? 1 : hour + 1;
                    speech = Math.random() > 0.5 ? "quarter to " + numToWords(next) : numToWords(hour) + " forty five";
                }
                else speech = numToWords(hour) + " " + numToWords(minute);
                return { target: hour + ":" + String(minute).padStart(2, "0"), speech, hint: "Time (H:MM)", type: "TIME" };
            },
            
            DATE: () => {
                const day = 1 + Math.floor(Math.random() * 28);
                const month = 1 + Math.floor(Math.random() * 12);
                return { target: day + "/" + month, speech: "the " + ordinal(day) + " of " + MONTHS[month], hint: "Date (D/M)", type: "DATE" };
            },
            
            YEAR: () => {
                const ranges = [[1900,1999], [2000,2009], [2010,2030]];
                const [min, max] = ranges[Math.floor(Math.random() * 3)];
                const year = min + Math.floor(Math.random() * (max - min + 1));
                let speech;
                if (year >= 2000 && year <= 2009) speech = year === 2000 ? "two thousand" : "two thousand and " + numToWords(year - 2000);
                else if (year >= 2010) speech = "twenty " + numToWords(year - 2000);
                else {
                    const [f, s] = [Math.floor(year / 100), year % 100];
                    speech = numToWords(f) + " " + (s ? numToWords(s) : "hundred");
                }
                return { target: String(year), speech, hint: "Year", type: "YEAR" };
            },
            
            PERCENT: () => {
                const whole = 1 + Math.floor(Math.random() * 99);
                if (Math.random() > 0.7) {
                    const dec = [1,2,3,4,5,25,75][Math.floor(Math.random() * 7)];
                    const decSpeech = String(dec).split("").map(d => numToWords(parseInt(d))).join(" ");
                    return { target: whole + "." + dec + "%", speech: numToWords(whole) + " point " + decSpeech + " percent", hint: "Percentage", type: "PERCENT" };
                }
                return { target: whole + "%", speech: numToWords(whole) + " percent", hint: "Percentage", type: "PERCENT" };
            },
            
            LARGE: () => {
                const isThou = Math.random() > 0.5;
                const n = isThou 
                    ? (1 + Math.floor(Math.random() * 9)) * 1000 + Math.floor(Math.random() * 1000)
                    : (1 + Math.floor(Math.random() * 9)) * 100 + Math.floor(Math.random() * 100);
                return { target: String(n), speech: numToWords(n), hint: "Large Number", type: "LARGE" };
            }
        };

        // State
        let currentQuestion = null;
        let stats = { correct: 0, total: 0, streak: 0 };
        let speed = 0.85;
        let activeCategories = new Set(Object.keys(generators));
        let weights = {};
        Object.keys(generators).forEach(k => weights[k] = 1);
        weights["TEEN_TY"] = 2;
        
        let selectedVoice = null;
        let englishVoices = [];

        // Initialize category toggles
        const catLabels = {
            TEEN_TY: "Teen/Ty", PHONE: "Phone", PRICE: "Price", TIME: "Time",
            DATE: "Date", YEAR: "Year", PERCENT: "Percent", LARGE: "Large"
        };
        const togglesContainer = document.getElementById("categoryToggles");
        Object.keys(generators).forEach(cat => {
            const btn = document.createElement("button");
            btn.className = "cat-btn active";
            btn.textContent = catLabels[cat];
            btn.onclick = () => {
                if (activeCategories.has(cat)) {
                    if (activeCategories.size > 1) {
                        activeCategories.delete(cat);
                        btn.classList.remove("active");
                    }
                } else {
                    activeCategories.add(cat);
                    btn.classList.add("active");
                }
            };
            togglesContainer.appendChild(btn);
        });

        // Speed buttons
        document.querySelectorAll(".setting-btn[data-speed]").forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll(".setting-btn[data-speed]").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                speed = parseFloat(btn.dataset.speed);
            };
        });

        // Voice selection
        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            englishVoices = voices.filter(v => v.lang.startsWith("en"));
            
            // Prefer high-quality voices
            const preferredKeywords = ["Natural", "Premium", "Enhanced", "Neural", "Siri", "Google", "Microsoft"];
            englishVoices.sort((a, b) => {
                const aScore = preferredKeywords.some(k => a.name.includes(k)) ? 1 : 0;
                const bScore = preferredKeywords.some(k => b.name.includes(k)) ? 1 : 0;
                return bScore - aScore;
            });
            
            const select = document.getElementById("voiceSelect");
            select.innerHTML = '<option value="random">üé≤ Random Voice</option>';
            
            englishVoices.forEach((voice, i) => {
                const opt = document.createElement("option");
                opt.value = i;
                const flag = voice.lang.includes("GB") ? "üá¨üáß" : 
                             voice.lang.includes("AU") ? "üá¶üá∫" : 
                             voice.lang.includes("US") ? "üá∫üá∏" : "üåê";
                opt.textContent = `${flag} ${voice.name}`;
                select.appendChild(opt);
            });
            
            // Auto-select first high-quality voice if available
            if (englishVoices.length > 0) {
                selectedVoice = englishVoices[0];
            }
        }
        
        document.getElementById("voiceSelect").addEventListener("change", (e) => {
            if (e.target.value === "random") {
                selectedVoice = null;
            } else {
                selectedVoice = englishVoices[parseInt(e.target.value)];
            }
        });

        function getVoice() {
            if (selectedVoice) return selectedVoice;
            if (englishVoices.length === 0) return null;
            return englishVoices[Math.floor(Math.random() * englishVoices.length)];
        }

        function speak(text) {
            return new Promise(resolve => {
                // Cancel any ongoing speech
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = speed;
                
                const voice = getVoice();
                if (voice) {
                    utterance.voice = voice;
                    utterance.lang = voice.lang;
                    
                    const flag = voice.lang.includes("GB") ? "üá¨üáß" : 
                                 voice.lang.includes("AU") ? "üá¶üá∫" : 
                                 voice.lang.includes("US") ? "üá∫üá∏" : "üåê";
                    document.getElementById("voiceIndicator").textContent = flag + " " + voice.name.split(" ")[0];
                }
                
                utterance.onend = resolve;
                utterance.onerror = resolve;
                
                // Small delay to ensure cancel is processed
                setTimeout(() => speechSynthesis.speak(utterance), 50);
            });
        }

        function generateQuestion() {
            const cats = Array.from(activeCategories);
            const catWeights = cats.map(c => weights[c]);
            const totalWeight = catWeights.reduce((a, b) => a + b, 0);
            let r = Math.random() * totalWeight;
            let chosen = cats[0];
            for (let i = 0; i < cats.length; i++) {
                r -= catWeights[i];
                if (r <= 0) { chosen = cats[i]; break; }
            }
            return generators[chosen]();
        }

        async function playQuestion() {
            const btn = document.getElementById("playBtn");
            const playText = document.getElementById("playText");
            const feedback = document.getElementById("feedback");
            
            if (!currentQuestion) {
                currentQuestion = generateQuestion();
                document.getElementById("typeBadge").textContent = currentQuestion.hint;
                document.getElementById("hintText").textContent = "";
                feedback.className = "feedback";
                document.getElementById("answerInput").value = "";
            }
            
            btn.disabled = true;
            playText.textContent = "Playing...";
            
            await speak(currentQuestion.speech);
            
            btn.disabled = false;
            playText.textContent = "Replay";
            document.getElementById("answerInput").focus();
        }

        function normalize(str, type) {
            str = str.trim().toLowerCase().replace(/[$¬£‚Ç¨\s]/g, "");
            if (type === "TIME") str = str.replace(/[.\-]/g, ":");
            return str;
        }

        function checkAnswer() {
            if (!currentQuestion) return;
            
            const input = document.getElementById("answerInput").value;
            const feedback = document.getElementById("feedback");
            const hintText = document.getElementById("hintText");
            
            const userAnswer = normalize(input, currentQuestion.type);
            const correctAnswer = normalize(currentQuestion.target, currentQuestion.type);
            
            stats.total++;
            
            if (userAnswer === correctAnswer) {
                stats.correct++;
                stats.streak++;
                feedback.textContent = "‚úÖ Correct!";
                feedback.className = "feedback correct";
                weights[currentQuestion.type] = Math.max(0.5, weights[currentQuestion.type] - 0.1);
            } else {
                stats.streak = 0;
                feedback.textContent = "‚ùå Wrong. Answer: " + currentQuestion.target;
                feedback.className = "feedback wrong";
                hintText.textContent = 'Speech: "' + currentQuestion.speech + '"';
                weights[currentQuestion.type] = Math.min(3, weights[currentQuestion.type] + 0.2);
                
                setTimeout(() => speak("The answer was, " + currentQuestion.speech), 500);
            }
            
            updateStats();
            currentQuestion = null;
            document.getElementById("playText").textContent = "Next Question";
        }

        function updateStats() {
            document.getElementById("correctCount").textContent = stats.correct;
            document.getElementById("totalCount").textContent = stats.total;
            document.getElementById("streak").textContent = stats.streak;
            
            const acc = stats.total > 0 ? Math.round(stats.correct / stats.total * 100) : 0;
            document.getElementById("accuracy").textContent = acc + "%";
            document.getElementById("progressFill").style.width = acc + "%";
        }

        // Handle Enter key
        document.getElementById("answerInput").addEventListener("keyup", e => {
            if (e.key === "Enter") {
                if (currentQuestion) checkAnswer();
                else playQuestion();
            }
        });

        // Load voices
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();
        
        // Reload voices after a delay (needed for some browsers)
        setTimeout(loadVoices, 100);
        setTimeout(loadVoices, 500);
    </script>
</body>
</html>
